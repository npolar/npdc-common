<!DOCTYPE html>
<form name="formula" class="formula" ng-if="form.fieldsets">
  <header ng-if="form.title">
    {{ form.title }}
  </header>

  <md-tabs md-autoselect md-dynamic-height md-border-bottom md-selected="selectedIndex">
    <md-tab label="{{fieldset.title}}" ng-disabled="fieldset.disabled" ng-repeat="fieldset in form.fieldsets">
      <md-whiteframe class="md-whiteframe-z1">
        <fieldset>
          <div formula:field-definition ng-repeat="field in fieldset.fields" ng-show="field.visible">
            <!-- input field-->
            <div ng-if="field.typeOf('input')" apply-md-type="field">
              <div ng-if="field.mdType === 'boolean'" layout="row" layout-align="space-between center">
                <label for="{{field.uid}}">{{ field.title }}</label>
                <div flex layout="row" layout-align="end center">
                  <md-checkbox ng-attr-id="field.uid" ng-model="field.value" aria-label="{{ field.title }}"></md-checkbox>
                </div>
                <div class="np-validation-message" role="alert">
                  {{ field.error }}
                </div>
              </div>
              <div ng-if="field.mdType === 'range'" layout="row" layout-align="space-between center">
                <label for="{{field.uid}}">{{ field.title }}</label>
                <md-slider flex min="{{field.minimum}}" max="{{field.maximum}}" step="{{field.step}}" md-discrete ng-model="field.value" aria-label="{{field.title}}" ng-attr-id="field.uid">
                </md-slider>
                <div class="np-validation-message" role="alert">
                  {{ field.error }}
                </div>
              </div>
              <md-input-container ng-if="field.mdType === 'select'">
                <label for="{{field.uid}}">{{ (field.required ? field.title + ' (required)' : field.title) }}</label>
                <md-select ng-model="field.value">
                  <md-option ng-repeat="val in field.enum" value="{{val}}">{{val}}</md-option>
                </md-select>
                <div class="np-validation-message" role="alert">
                  {{ field.error }}
                </div>
              </md-input-container>
              <md-input-container ng-if="field.mdType === 'input'" title="{{ field.description }}">
                <label for="{{field.uid}}">{{ (field.required ? field.title + ' (required)' : field.title) }}</label>
                <div formula:field="field"></div>
                <div class="np-validation-message md-caption" role="alert">
                  {{ field.error }}
                </div>
              </md-input-container>
            </div>



            <div ng-if="field.typeOf('object')">
              <md-whiteframe class="md-whiteframe-z1">
                <fieldset formula:field="field">
                  <legend>{{ field.title }}</legend>

                  <div ng-repeat="field in field.fields" ng-show="field.visible">
                    <formula:field-instance field="field"></formula:field-instance>
                  </div>
                </fieldset>
              </md-whiteframe>
            </div>

            <div ng-if="field.typeOf('array')">
              <div formula:field="field">
                <md-whiteframe class="md-whiteframe-z1">
                  <fieldset ng-class="{ valid: field.valid, error: field.error }">
                    <legend>{{ field.title }} ({{ field.values.length || 0 }})</legend>
                    <div ng-if="field.typeOf('fieldset')">
                      <ul class="np-formula-array">
                        <li ng-repeat="value in field.values">
                          <md-whiteframe class="md-whiteframe-z1">
                            <fieldset ng-class="{ valid: value.valid }">
                              <legend>
                                <span ng-if="!value.visible">{{ value.fields | formulaInlineValues }}</span>
                              </legend>
                              <div class="np-formula-object-ctrls">
                                <a class="toggle" href="" ng-click="field.itemToggle($index)" title="{{ value.visible ? form.i18n.minimize[1] : form.i18n.maximize[1] }}">
                                  <md-icon>{{ value.visible ? 'expand_less' : 'expand_more' }}</md-icon>
                                </a>
                                <a class="remove" href="" ng-click="field.itemRemove($index)" title="{{ form.i18n.remove[1] }}">
                                  <md-icon>close</md-icon>
                                </a>
                              </div>

                              <div class="np-formula-subarray" ng-repeat="subfield in field.fields" ng-show="value.visible">
                                <formula:field-instance field="value.fields[$index]" ng-show="subfield.visible"></formula:field-instance>
                              </div>
                            </fieldset>
                          </md-whiteframe>
                        </li>
                      </ul>
                      <div class="np-formula-array-add">
                        <md-button ng-click="field.itemAdd()" class="md-fab md-mini" aria-label="{{ form.i18n.add[1] }}">
                          <md-icon>add</md-icon>
                        </md-button>
                      </div>
                    </div>

                    <div ng-if="field.typeOf('field')">
                      <ul class="np-formula-array">
                        <li ng-class="{ valid: value.valid, error: value.error }" ng-repeat="value in field.values" layout="row">
                          <formula:field-instance field="value" flex></formula:field-instance>
                          <a class="np-formula-input-ctrls remove" href="" ng-click="field.itemRemove($index)" title="{{ form.i18n.remove[1] }}">
                            <md-icon>close</md-icon>
                          </a>
                        </li>
                      </ul>
                      <div class="np-formula-array-add">
                        <md-button ng-click="field.itemAdd()" class="md-fab md-mini" aria-label="{{ form.i18n.add[1] }}">
                          <md-icon>add</md-icon>
                        </md-button>
                      </div>
                    </div>

                  </fieldset>
                </md-whiteframe>
              </div>
            </div>
          </div>
        </fieldset>
      </md-whiteframe>

    </md-tab>
  </md-tabs>

  <footer layout="row" layout-align="space-between center" ng-if="!(form.uiValidateHidden && form.uiSaveHidden)">
    <span ng-if="form.errors" title="{{ form.errors.join('\n') }}">{{ form.i18n.invalid | formulaReplace : { count: form.errors.length } }}</span>

    <div>
      <md-button class="md-raised" ng-click="form.validate()" ng-if="!form.uiValidateHidden" title="{{ form.i18n.validate[1] }}">
        <md-icon>check</md-icon> {{ form.i18n.validate[0] }}</md-button>
      <md-button class="md-raised md-primary" ng-click="form.save()" ng-disabled="!form.valid" ng-if="!form.uiSaveHidden" title="{{ form.i18n.save[1] }}">
        <md-icon>save</md-icon> {{ form.i18n.save[0] }}</md-button>

    </div>

  </footer>
</form>

<div class="formula" ng-if="!form.fieldsets">
  <div layout="row" layout-sm="column" layout-align="space-around">
    <md-progress-circular md-mode="indeterminate"></md-progress-circular>
  </div>
</div>
